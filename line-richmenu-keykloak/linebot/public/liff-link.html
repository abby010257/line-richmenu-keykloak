<!-- åŸæœ¬ç›´æ¥å‘¼å« /app/api/bind-line çš„æ¨¡æ“¬ç¶å®šæµç¨‹ï¼Œæ”¹ç‚ºé¡¯ç¤ºã€Œç¶å®šæŒ‰éˆ•ã€ï¼ŒæŒ‰ä¸‹å¾Œå¸¶ lineUserId åˆ° /app/start-bindã€‚ -->

<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LINE ç¶å®šé©—è­‰</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; background: #f6f7fb; color: #333; text-align: center; padding: 40px 10px; }
    .card { background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); display: inline-block; text-align: left; width: 90%; max-width: 400px; }
    img { border-radius: 50%; width: 80px; height: 80px; margin: 10px auto; display: block; }
    pre { background: #f1f1f1; border-radius: 8px; padding: 10px; text-align: left; white-space: pre-wrap; word-wrap: break-word; font-size: 13px; }
    .btn { display:inline-block; padding:10px 16px; border-radius:8px; background:#2ea44f; color:#fff; text-decoration:none; }
  </style>
</head>
<body>
  <h2>ğŸ”— LINE ç¶å®šé©—è­‰</h2>
  <div id="profile" class="card" style="display:none;">
    <img id="picture" src="" alt="Profile Picture" />
    <h3 id="name"></h3>
    <div id="bind-area" style="margin-top:10px;"></div>
  </div>

  <pre id="result">è¼‰å…¥ä¸­...</pre>
  <button id="closeBtn" class="btn">é—œé–‰è¦–çª—</button>
  <p id="bindResult"></p>

  <script>
  const LIFF_ID = "2008435803-rJRMBOEA";
  const REDIRECT_URL = "https://genie-unfussing-persuadingly.ngrok-free.dev/app/liff-link.html";

  if (new URL(location.href).searchParams.get("bind") === "success") {
    const resultEl = document.getElementById("result");
    resultEl.innerHTML = "ğŸ‰ ç¶å®šæˆåŠŸï¼<br>3 ç§’å¾Œå°‡è‡ªå‹•è¿”å› LINE";
    setTimeout(() => {
      window.location.href = "https://line.me/";
    }, 3000);
    // ä¸é€²å…¥å¾Œé¢ LIFF login æµç¨‹
  }else{
    initLiff();
  }
  
  async function initLiff() {
    try {
      await liff.init({ liffId: LIFF_ID });
      logToScreen("âœ… LIFF åˆå§‹åŒ–æˆåŠŸ");

      const isInLineApp = liff.isInClient();
      logToScreen("ğŸ“± æ˜¯å¦åœ¨ LINE App å…§:", isInLineApp);

      if (!isInLineApp && !liff.isLoggedIn()) {
        logToScreen("ğŸŒ å¤–éƒ¨ç™»å…¥æµç¨‹å•Ÿå‹•...");
        liff.login({ redirectUri: REDIRECT_URL });
        return;
      }

      const accessToken = liff.getAccessToken();
      if (!accessToken) {
        document.getElementById("result").textContent = "âš ï¸ ç„¡æ³•å–å¾— access_token";
        return;
      }
      logToScreen("ğŸ”‘ å–å¾— accessToken:", accessToken.substring(0, 20) + "...");

      // 1) é©—è­‰ LINE token ä¸¦æ‹¿åˆ° profileï¼ˆå‘¼å« server çš„ /app/verify-lineï¼‰
      const verifyRes = await fetch("/app/verify-line", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ accessToken }),
      });
      const verifyData = await verifyRes.json();
      logToScreen("âœ… Token é©—è­‰çµæœ:", verifyData);

      if (verifyData.success && verifyData.profile) {
        const profile = verifyData.profile;
        document.getElementById("profile").style.display = "block";
        document.getElementById("picture").src = profile.pictureUrl;
        document.getElementById("name").textContent = profile.displayName;

        // åœ¨ç•«é¢ä¸Šé¡¯ç¤ºç¶å®šæŒ‰éˆ•ï¼ˆå°åˆ° /app/start-bind?lineUserId=... ï¼‰
        const bindArea = document.getElementById("bind-area");
        bindArea.innerHTML = '';
        const bindLink = document.createElement('a');
        bindLink.className = 'btn';
        bindLink.href = `/app/start-bind?lineUserId=${encodeURIComponent(profile.userId)}`;
        bindLink.textContent = 'ğŸ”— é»æ­¤ç¶å®š Keycloak';
        bindArea.appendChild(bindLink);

        // è‹¥ä¹‹å‰å·²å¾ Keycloak å®Œæˆç¶å®šï¼Œå‰ç«¯å¯å‘¼å« /app/api/bind-result å–å¾—ç¶å®šçµæœä¸¦é¡¯ç¤º
        const br = await fetch('/app/api/bind-result');
        const brj = await br.json();
        if (brj && brj.ok) {
          document.getElementById('bindResult').textContent = brj.message;
        }
      }

      document.getElementById("result").textContent = JSON.stringify(verifyData, null, 2);
    } catch (err) {
      console.error("âŒ LIFF åˆå§‹åŒ–éŒ¯èª¤:", err);
      document.getElementById("result").textContent = "LIFF åˆå§‹åŒ–æˆ–ç™»å…¥éŒ¯èª¤ï¼š" + err.message;
    }
  }

  function logToScreen(...args) {
    const msg = args.map(a => (typeof a === "object" ? JSON.stringify(a, null, 2) : a)).join(" ");
    const logEl = document.getElementById("result");
    logEl.textContent += "\n" + msg;
    console.log(...args);
  }

  </script>
</body>
</html>